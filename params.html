<!DOCTYPE html>
<html lang="en">
<head>
    <title>Dynamic Data Input Form with Distribution Types</title>
</head>
<body>
    <form id="dataForm"></form>
    <button type="submit" id="submitBtn">Submit</button>


    <script>
        const formFields = [
            { id: "INEQUALITY", label: "Inequality", distribution: "fixed", default: 0.001 },
            { id: "WEALTH", label: "Wealth", distribution: "lognormal", mean: 1.1356082157016467, stddev: 1.1184432636889245 },
            { id: "POSTURE", label: "Posture", distribution: "truncated_normal", mean: 0.28, stddev: 0.10, min: 0.0, max: 1.0 },
            { id: "RANSOM_B0", label: "Ransom B0", distribution: "fixed", default: 792145 },
            { id: "RANSOM_B1", label: "Ransom B1", distribution: "fixed", default: 0.00121 },
            { id: "RECOVERY_COST_BASE", label: "Recovery Cost Base", distribution: "fixed", default: 230123 },
            { id: "RECOVERY_COST_EXP", label: "Recovery Cost Exp", distribution: "fixed", default: 0.125 },
            { id: "NUM_QUOTES", label: "Number of Quotes", distribution: "fixed", default: 10 }
        ];

        // Define the fields needed for each distribution type
        const distributionFields = {
            fixed: ['val'],
            normal: ['mean', 'stddev'],
            lognormal: ['mean', 'stddev'],
            truncated_normal: ['mean', 'stddev', 'min', 'max'],
            uniform : ['min', 'max']
        };

        const form = document.getElementById("dataForm");

        formFields.forEach(field => {
            const fieldWrapper = document.createElement("div");
            fieldWrapper.id = `wrapper-${field.id}`;
            form.appendChild(fieldWrapper);

             // Add a static header with the field's id name, only once
            const heading = document.createElement("h4");
            heading.textContent = `${field.id}`;
            fieldWrapper.appendChild(heading);

            const label = document.createElement("label");
            label.for = field.id;
            label.textContent = `${field.label} (${field.distribution}): `;
            fieldWrapper.appendChild(label);

            const select = document.createElement("select");
            select.id = `${field.id}-distribution`;
            select.name = `${field.id}-distribution`;
            ["fixed", "normal", "lognormal", "truncated_normal", "uniform"].forEach(dist => {
                const option = document.createElement("option");
                option.value = dist;
                option.textContent = dist;
                option.selected = dist === field.distribution;
                select.appendChild(option);
            });
            fieldWrapper.appendChild(select);

            // Create fields based on the default distribution type
            createDistributionFields(field.id, field.distribution, field);
            console.log(field.id);

            // Update fields dynamically based on selected distribution
            select.addEventListener("change", function () {
                const selectedDist = select.value;
                createDistributionFields(field.id, selectedDist, field);
            });
        });

        function createDistributionFields(fieldId, distribution, field) {
            const fieldWrapper = document.getElementById(`wrapper-${fieldId}`);
            
            // Remove any existing input fields for this parameter
            const existingFields = fieldWrapper.querySelectorAll("input:not([name$='-distribution']), label:not([for$='-distribution']), br");
            existingFields.forEach(el => el.remove());


            // Ensure the distribution type is defined in the dictionary
            const fieldsToAdd = distributionFields[distribution];
            if (!fieldsToAdd) {
                console.error(`Distribution type "${distribution}" is not defined in distributionFields.`);
                return;
            }

            // Add new fields based on the selected distribution type
            fieldsToAdd.forEach((param, index) => {
                const input = document.createElement("input");
                input.type = "number";
                input.name = `${fieldId}-${param}`;
                input.id = `${fieldId}-${param}-${index}`; // Make id unique by adding the index

                input.value = field[param] || 0;

                const paramLabel = document.createElement("label");
                paramLabel.for = input.id;  // Set 'for' attribute to match the unique id
                paramLabel.textContent = ` ${param}: `;
                
                fieldWrapper.appendChild(paramLabel);
                fieldWrapper.appendChild(input);
                // fieldWrapper.appendChild(document.createElement("br"));
            });
        }

        // Collect form data and submit
        document.getElementById("submitBtn").addEventListener("click", function (e) {
            e.preventDefault();
            const formData = {};
            formFields.forEach(field => {
                const distribution = document.getElementById(`${field.id}-distribution`).value;
                formData[field.id] = { distribution };
                distributionFields[distribution].forEach(param => {
                    formData[field.id][param] = parseFloat(document.getElementById(`${field.id}-${param}`).value);
                });
            });

            fetch('process.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(result => {
                const plotData = result.plotData;
                Plotly.newPlot('plotly-div', plotData);
            })
            .catch(error => console.error('Error:', error));
        });
    </script>
</body>
</html>
